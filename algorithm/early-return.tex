\begin{algorithm}[ht]
    \caption{Early-Return Edges Detection}
    \label{algo:runtime-shape-check-detection}
    \footnotesize
    \SetKwFunction{RunOnFunction}{RunOnFunction}
    \SetKwFunction{MarkEarlyReturnEdge}{MarkEarlyReturnEdge}
    \SetKwFunction{GetPhiOperand}{GetPhiOperand}
    \SetKwFunction{PushBack}{PushBack}
    \SetKwFunction{Pop}{Pop}
    \SetKwFunction{IsPhi}{IsPhi}
    \SetKwFunction{IsCall}{IsCall}
    \SetKwFunction{IsConstant}{IsConstant}
    \SetKwFunction{GetIDom}{GetIDom} 
    
    \SetKwProg{Fn}{Function}{:}{}
    
    \Fn{\RunOnFunction{$F,\;\mathcal{E},\;\mathcal{S}$}}{
        $B_{exit} \gets$ exit block of $F$\;
        \tcp{Worklist stores pairs of (Value, IncomingBlock)}
        $W \gets \GetPhiOperand(B_{exit})$\;
        \While{$W \neq \varnothing$}{
            $(v, B) \gets W.\Pop{}$\;
            \uIf{\IsPhi{$v$} defined in block $B$}{
                $W.\PushBack(\GetPhiOperand(v))$\;
            }
            \Else{
                % Found a value source v reaching exit via block B. 
                $is\_detected \gets \text{false}$\;
                $Dom \gets B$\;
                
                % Traverse up the Dominator Tree to find the shape check
                \While{$Dom \neq \text{null} \land \neg is\_detected$}{
                    $br\ x \bowtie c,\ S_{true},\ S_{false} \gets$ branch in $Dom$\;
                    
                    \If{is a conditional branch}{
                        $E_{fail} \gets \text{null}$\;
                        \If{$(\bowtie = eq \land c \in \mathcal{E}) \lor (\bowtie = neq \land c \in \mathcal{S})$}
                            {$E_{fail} \gets S_{true}$}
                        \If{$(\bowtie = eq \land c \in \mathcal{S}) \lor (\bowtie = neq \land c \in \mathcal{E})$}
                            {$E_{fail} \gets S_{false}$}
                        
                        \If{$E_{fail} \neq \text{null} \land E_{fail} \text{ dominates } B$}{
                            \If{(\IsCall{$x$} $\land\ v = x$) $\lor$ (\IsCall{$x$} $\land\ v \in \mathcal{E}$)}{
                                \MarkEarlyReturnEdge($E_{fail}$)\;
                                \RunOnFunction{callee of $x$, $\mathcal{E},\ \mathcal{S}$}\;
                                $is\_detected \gets \text{true}$\;
                            }
                        }
                    }
                    $Dom \gets \GetIDom(Dom)$\;
                }
                
                \If{$\neg is\_detected$}{
                    % Pattern 3: Tail Call (recurse)
                    \If{\IsCall{$v$}}{
                        \RunOnFunction{callee of $v$, $\mathcal{E},\ \mathcal{S}$}\;
                    }
                    % Fallback: Local check returning constant error (e.g., s % 32 != 0)
                    % Just mark the path from B to Exit as early-return
                    \ElseIf{\IsConstant{$v$} $\land\ v \in \mathcal{E}$}{
                        \MarkEarlyReturnEdge($\text{Edge}(B \to B_{exit})$)\;
                    }
                }
            }
        }
    }
\end{algorithm}